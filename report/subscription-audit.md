# üîç AUDITORIA COMPLETA - SISTEMA DE VERIFICA√á√ÉO DE ASSINATURA
## Projeto: Pizza Prime/Clube do Rei

**Data da Auditoria:** 25 de Setembro de 2025  
**Status:** CR√çTICO - M√∫ltiplas inconsist√™ncias detectadas  
**Impacto:** Sistema de verifica√ß√£o confuso, duplicado e com potencial falha de seguran√ßa  

---

## üìÇ 1. MAPEAMENTO DE ARQUIVOS RELACIONADOS √Ä SUBSCRIPTION

### 1.1 Arquivos Front-end (React)
| Arquivo | Linhas | Fun√ß√£o Principal | Verifica√ß√£o de Assinatura |
|---------|--------|------------------|---------------------------|
| `src/hooks/useUnifiedAuth.tsx` | 708 | Hook central de autentica√ß√£o e assinatura | ‚úÖ `checkSubscriptionInternal()` (160-309), `hasValidSubscription()` (627-629) |
| `src/routes/UnifiedProtectedRoute.tsx` | 113 | Guard de rotas com verifica√ß√£o | ‚úÖ Linha 101: `!subscription.subscribed` |
| `src/components/SubscriptionStatus.tsx` | 35 | UI de status visual | ‚úÖ Linha 18: `hasValidSubscription()` |
| `src/components/SubscriptionPlans.tsx` | 144 | Interface de planos | ‚ùå Apenas exibe planos |
| `src/pages/SubscriptionPlans.tsx` | 89 | P√°gina de planos | ‚ùå Apenas renderiza√ß√£o |
| `src/pages/Dashboard.tsx` | 382+ | Dashboard principal | ‚úÖ Usa `subscription` state |
| `src/pages/Index.tsx` | 118+ | P√°gina inicial | ‚úÖ Linha 32: `hasValidSubscription()` |

### 1.2 Edge Functions (Supabase)
| Arquivo | Fun√ß√£o | Verifica√ß√£o Principal | Environment Variables |
|---------|--------|--------------------|---------------------|
| `supabase/functions/check-subscription/index.ts` | Verifica√ß√£o principal de assinatura | ‚úÖ Stripe API + DB local | `STRIPE_SECRET_KEY`, `STRIPE_PRICE_ID_*` |
| `supabase/functions/validate-subscription-realtime/index.ts` | Valida√ß√£o em tempo real | ‚úÖ Dupla verifica√ß√£o (DB + Stripe) | `STRIPE_SECRET_KEY` |
| `supabase/functions/stripe-webhook/index.ts` | Webhook Stripe | ‚úÖ Sincroniza√ß√£o autom√°tica | `STRIPE_SECRET_KEY`, `STRIPE_WEBHOOK_SECRET` |
| `supabase/functions/create-checkout/index.ts` | Cria√ß√£o de checkout | ‚ùå Apenas cria√ß√£o | `STRIPE_SECRET_KEY`, `STRIPE_PRICE_ID_*` |
| `supabase/functions/customer-portal/index.ts` | Portal do cliente | ‚ùå Apenas portal | `STRIPE_SECRET_KEY` |

### 1.3 Banco de Dados
**Tabela Principal:** `public.subscriptions`
```sql
-- Schema da tabela subscriptions
{
  id: uuid PRIMARY KEY,
  user_id: uuid REFERENCES profiles(id),
  stripe_subscription_id: text,
  stripe_price_id: text,
  status: subscription_status ENUM, -- 'active', 'inactive', 'pending', 'cancelled'
  plan_name: text,
  plan_price: numeric,
  expires_at: timestamp,
  sync_status: text, -- 'webhook', 'manual', 'pending'
  last_webhook_event: text,
  webhook_event_id: text,
  created_at: timestamp,
  updated_at: timestamp
}
```

---

## üîß 2. FLUXO ATUAL DE VERIFICA√á√ÉO

### 2.1 Login/Registro do Usu√°rio
```mermaid
sequenceDiagram
    participant U as Usu√°rio
    participant F as Frontend (useUnifiedAuth)
    participant S as Supabase Auth
    participant E as Edge Function
    participant DB as Database
    participant ST as Stripe

    U->>F: signIn(email, password)
    F->>S: auth.signInWithPassword()
    S-->>F: { user, session }
    F->>F: setUser, setSession
    F->>E: invoke('check-subscription')
    E->>DB: SELECT FROM subscriptions WHERE user_id AND status='active'
    
    alt Assinatura ativa no DB
        DB-->>E: subscription data
        E-->>F: { subscribed: true, ... }
    else Nenhuma assinatura local
        E->>ST: customers.list({ email })
        E->>ST: subscriptions.list({ customer, status: 'active' })
        ST-->>E: stripe subscription data
        E->>DB: UPSERT subscription
        E-->>F: { subscribed: boolean, ... }
    end
    
    F->>F: setSubscription()
    F->>F: localStorage cache
```

### 2.2 Verifica√ß√£o em Rotas Protegidas
```javascript
// UnifiedProtectedRoute.tsx - Linha 101
if (requireSubscription && user && !subscription.loading && !subscription.subscribed && location.pathname === '/menu') {
  return <Navigate to="/plans" replace />;
}
```

### 2.3 Verifica√ß√£o em Componentes
```javascript
// useUnifiedAuth.tsx - Linha 627-629
const hasValidSubscription = useCallback(() => {
  return subscription.subscribed && subscription.status === 'active';
}, [subscription.subscribed, subscription.status]);
```

---

## ‚ö†Ô∏è 3. PROBLEMAS CR√çTICOS IDENTIFICADOS

### üî¥ CR√çTICO - Duplica√ß√£o de L√≥gica de Verifica√ß√£o
**Arquivo:** `src/hooks/useUnifiedAuth.tsx` vs `supabase/functions/validate-subscription-realtime/index.ts`
- **Problema:** Duas edge functions fazem verifica√ß√£o similar
- **Linhas Afetadas:** useUnifiedAuth:160-309, validate-subscription-realtime:53-213
- **Impacto:** Conflitos de estado, chamadas desnecess√°rias √† API do Stripe

### üî¥ CR√çTICO - Cache Inconsistente
**Arquivo:** `src/hooks/useUnifiedAuth.tsx`
- **Problema:** Cache no localStorage pode ficar desatualizado
- **Linhas Afetadas:** 168-195, 223-227, 264-267
- **Impacto:** Usu√°rio pode acessar recursos premium sem assinatura v√°lida

### üî¥ CR√çTICO - Race Condition no Auth State
**Arquivo:** `src/hooks/useUnifiedAuth.tsx`
- **Problema:** `checkSubscriptionInternal` pode ser chamado antes do user estar totalmente autenticado
- **Linhas Afetadas:** 90-96
- **Impacto:** Chamadas √† edge function com token inv√°lido

### üü† ALTO - Verifica√ß√£o Apenas em /menu
**Arquivo:** `src/routes/UnifiedProtectedRoute.tsx`
- **Problema:** Linha 101 s√≥ verifica assinatura se `location.pathname === '/menu'`
- **Impacto:** Outras rotas protegidas podem ser acessadas sem assinatura

### üü† ALTO - M√∫ltiplos Hooks de Role
**Arquivos:** `src/hooks/useRole.tsx` vs `src/hooks/useUnifiedProfile.tsx`
- **Problema:** L√≥gica duplicada para verifica√ß√£o de pap√©is
- **Impacto:** Inconsist√™ncia entre componentes

### üü° M√âDIO - Fallback sem Verifica√ß√£o
**Arquivo:** `supabase/functions/check-subscription/index.ts`
- **Problema:** Linha 244-286 retorna status baseado apenas no DB local
- **Impacto:** Assinatura cancelada no Stripe pode aparecer como ativa

---

## üõ°Ô∏è 4. AN√ÅLISE DE SEGURAN√áA

### 4.1 Webhooks Implementados
‚úÖ **Stripe Webhook:** `supabase/functions/stripe-webhook/index.ts`
- Verifica√ß√£o de assinatura: `STRIPE_WEBHOOK_SECRET`
- Eventos tratados: `customer.subscription.*`, `invoice.payment_*`, `checkout.session.completed`

‚ùå **MercadoPago Webhook:** `supabase/functions/mercadopago-webhook/index.ts`
- **PROBLEMA:** N√£o atualiza tabela `subscriptions`, apenas transa√ß√µes PIX/cart√£o
- **IMPACTO:** Assinaturas via MercadoPago n√£o s√£o sincronizadas

### 4.2 Vari√°veis de Ambiente Cr√≠ticas
| Vari√°vel | Uso | Status | Impacto se Comprometida |
|----------|-----|--------|------------------------|
| `STRIPE_SECRET_KEY` | Verifica√ß√£o de assinaturas | ‚úÖ Presente | üî¥ Total - Acesso a todos os dados do Stripe |
| `STRIPE_WEBHOOK_SECRET` | Valida√ß√£o de webhooks | ‚úÖ Presente | üü† M√©dio - Webhooks falsos |
| `STRIPE_PRICE_ID_ANNUAL` | Identifica√ß√£o de plano anual | ‚úÖ Presente | üü° Baixo - Confus√£o de planos |
| `STRIPE_PRICE_ID_MONTHLY` | Identifica√ß√£o de plano mensal | ‚úÖ Presente | üü° Baixo - Confus√£o de planos |
| `STRIPE_PRICE_ID_TRIAL` | Identifica√ß√£o de plano trial | ‚úÖ Presente | üü° Baixo - Confus√£o de planos |

---

## üìä 5. MATRIZ DE INCONSIST√äNCIAS

### 5.1 Tipos de Retorno Diferentes
| Componente | Retorno de `isSubscribed` | Localiza√ß√£o |
|------------|---------------------------|-------------|
| `useUnifiedAuth.hasValidSubscription()` | `boolean` | Linha 627 |
| `subscription.subscribed` | `boolean` | Interface SubscriptionStatus |
| `subscription.status` | `string` | 'active', 'inactive', 'pending', 'cancelled' |
| Edge Function `check-subscription` | `{ subscribed: boolean, status: string }` | Resposta JSON |

### 5.2 Condi√ß√µes de Verifica√ß√£o Diferentes
```javascript
// useUnifiedAuth.tsx
return subscription.subscribed && subscription.status === 'active';

// UnifiedProtectedRoute.tsx  
!subscription.subscribed

// check-subscription edge function
status: hasActiveSub ? 'active' : 'inactive'
```

---

## üîß 6. PLANO DE CORRE√á√ÉO M√çNIMO E SEGURO

### FASE 1: HOTFIX CR√çTICO (Implementar IMEDIATAMENTE)

#### 6.1 Corre√ß√£o da Verifica√ß√£o de Rota
**Arquivo:** `src/routes/UnifiedProtectedRoute.tsx`
```diff
// Linha 101 - ANTES
- if (requireSubscription && user && !subscription.loading && !subscription.subscribed && location.pathname === '/menu') {
+ if (requireSubscription && user && !subscription.loading && !subscription.subscribed) {
```

#### 6.2 Invalida√ß√£o de Cache no Logout
**Arquivo:** `src/hooks/useUnifiedAuth.tsx`
```diff
// Adicionar ap√≥s linha 461
+ Object.keys(localStorage).forEach(key => {
+   if (key.startsWith('subscription_data_') || key.startsWith('subscription_last_check_')) {
+     localStorage.removeItem(key);
+   }
+ });
```

### FASE 2: CONSOLIDA√á√ÉO (7 dias)

#### 6.3 Unificar Verifica√ß√£o de Assinatura
**Criar:** `src/hooks/useSubscriptionValidator.tsx`
```typescript
export const useSubscriptionValidator = () => {
  // √öNICA fonte de verdade para verifica√ß√£o
  const validateSubscription = async (userId: string): Promise<SubscriptionValidation> => {
    // 1. Verificar DB local primeiro
    // 2. Se expirada ou inconsistente, verificar Stripe
    // 3. Atualizar DB se necess√°rio
    // 4. Retornar resultado padronizado
  }
}
```

#### 6.4 Remover Edge Function Duplicada
**A√ß√£o:** Deletar `supabase/functions/validate-subscription-realtime/index.ts`
**Motivo:** Funcionalidade duplicada com `check-subscription`

#### 6.5 Padronizar Interface de Resposta
```typescript
interface SubscriptionValidation {
  isValid: boolean;
  status: 'active' | 'inactive' | 'expired' | 'pending' | 'cancelled';
  expiresAt: string | null;
  planName: string;
  planPrice: number;
  lastChecked: string;
}
```

### FASE 3: OTIMIZA√á√ÉO (14 dias)

#### 6.6 Implementar Cache Distribu√≠do
- Mover cache do localStorage para React Query com TTL de 5 minutos
- Invalida√ß√£o autom√°tica em eventos de webhook

#### 6.7 Monitoramento e Alertas
- Log de auditoria para todas verifica√ß√µes de assinatura
- Alertas para inconsist√™ncias entre Stripe e DB local

---

## üß™ 7. TESTES OBRIGAT√ìRIOS

### 7.1 Cen√°rios de Teste Manual
1. **Usu√°rio com assinatura ativa:**
   - Login ‚Üí Dashboard ‚Üí Menu (deve funcionar)
   - Expira√ß√£o durante sess√£o ativa

2. **Usu√°rio sem assinatura:**
   - Login ‚Üí Tentar acessar /menu ‚Üí Redirect para /plans
   - Tentar acessar /checkout ‚Üí Redirect para /plans

3. **Webhook Stripe:**
   - Cancelamento de assinatura ‚Üí Verificar bloqueio imediato
   - Renova√ß√£o ‚Üí Verificar libera√ß√£o imediata

4. **Cache invalidation:**
   - Logout ‚Üí Login ‚Üí Verificar cache limpo
   - Mudan√ßa de plano ‚Üí Verificar atualiza√ß√£o

### 7.2 Queries SQL para Auditoria
```sql
-- Verificar inconsist√™ncias
SELECT 
  u.email,
  s.status,
  s.expires_at,
  s.sync_status,
  s.stripe_subscription_id,
  CASE 
    WHEN s.expires_at < NOW() AND s.status = 'active' THEN 'EXPIRED_BUT_ACTIVE'
    WHEN s.stripe_subscription_id IS NULL AND s.status = 'active' THEN 'ACTIVE_WITHOUT_STRIPE'
    ELSE 'OK'
  END as inconsistency
FROM profiles u
LEFT JOIN subscriptions s ON u.id = s.user_id
WHERE s.id IS NOT NULL;
```

---

## üìã 8. CHECKLIST DE IMPLEMENTA√á√ÉO

### ‚úÖ Fase 1 - Hotfix (URGENTE)
- [ ] Corrigir verifica√ß√£o de rota em `UnifiedProtectedRoute.tsx`
- [ ] Adicionar limpeza completa de cache no logout
- [ ] Testar cen√°rios b√°sicos de acesso

### ‚è≥ Fase 2 - Consolida√ß√£o (7 dias)
- [ ] Criar hook unificado `useSubscriptionValidator`
- [ ] Migrar todas as verifica√ß√µes para o novo hook
- [ ] Remover `validate-subscription-realtime` edge function
- [ ] Padronizar interface de resposta
- [ ] Implementar logs de auditoria

### üîÑ Fase 3 - Otimiza√ß√£o (14 dias)
- [ ] Implementar React Query para cache
- [ ] Configurar monitoramento e alertas
- [ ] Documentar fluxo final
- [ ] Treinar equipe no novo sistema

---

## üéØ 9. √öNICA FONTE DE VERDADE PROPOSTA

### 9.1 Fluxo Unificado Final
```mermaid
graph TD
    A[User Login] --> B[useUnifiedAuth]
    B --> C[checkSubscription]
    C --> D{Local DB Valid?}
    D -->|Yes| E[Return Cached]
    D -->|No/Expired| F[Check Stripe API]
    F --> G[Update Local DB]
    G --> H[Return Fresh Data]
    E --> I[hasValidSubscription]
    H --> I
    I --> J[Route Guards]
    J --> K[Component Access]
```

### 9.2 Contratos de API Internos
```typescript
// GET /api/subscription/:userId - SEMPRE retorna
{
  status: 'active' | 'inactive' | 'expired' | 'pending' | 'cancelled',
  expires_at: string | null,
  plan_name: string,
  plan_price: number,
  last_verified: string
}
```

---

## üö® 10. RISCOS IDENTIFICADOS

| Prioridade | Risco | Impacto | Probabilidade | A√ß√£o |
|------------|-------|---------|---------------|------|
| üî¥ CR√çTICO | Acesso sem assinatura via cache | Alto | Alta | Hotfix imediato |
| üî¥ CR√çTICO | Race condition no auth | Alto | M√©dia | Debounce + validation |
| üü† ALTO | Inconsist√™ncia Stripe-DB | M√©dio | Alta | Webhook monitoring |
| üü° M√âDIO | Cache stale ap√≥s expira√ß√£o | Baixo | M√©dia | TTL reduction |

---

**‚ö° A√á√ÉO IMEDIATA REQUERIDA:** Implementar Fase 1 (Hotfix) em at√© 24 horas para evitar acesso n√£o autorizado a recursos premium.

**üìû Contato para Esclarecimentos:** Equipe de Desenvolvimento  
**üìÖ Pr√≥xima Revis√£o:** 7 dias ap√≥s implementa√ß√£o da Fase 1